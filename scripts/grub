#!/usr/bin/bash
set -euo pipefail
trap 'echo "Error en línea $LINENO. Comando: $BASH_COMMAND"' ERR

# Mostrar las unidades disponibles para que el usuario seleccione dónde instalar GRUB
echo "===== Unidades disponibles para instalar GRUB ====="
lsblk -d -o NAME,SIZE,MODEL
echo
#read -rp "Ingrese el nombre de la unidad (ejemplo: sda): " disk
disk="instalargruben"
GRUB_DISK="/dev/$disk"

# Actualizar las bases e instalar dependencias críticas
pacman -Syy --noconfirm grub efibootmgr os-prober  # Modificado: paquetes actualizados

# Verificar montaje de EFI en nuevo directorio
if ! mountpoint -q /boot/efi; then  # Modificado: directorio /efi en minúsculas
    echo "Error: La partición EFI no está montada en /boot/efi."
    echo "Asegúrate de haber creado y montado una partición EFI antes de continuar."
    exit 1
fi

# Reemplazar configuración de GRUB
[ -f /etc/default/grub ] && rm /etc/default/grub
mv ./grub_conf /etc/default/grub

# Instalación de GRUB con opciones mejoradas
echo "Instalando GRUB en modo UEFI..."
grub-install --target=x86_64-efi \
    --efi-directory=/efi \          # Directorio UEFI estándar
    --bootloader-id=ARCH_CRYPT \
    --modules="luks2 part_gpt cryptodisk ext2 gcry_sha512 gcry_rijndael" \
    --recheck \
    --debug

# Generar configuración incluyendo otros sistemas
echo "Generando configuración de GRUB..."
grub-mkconfig -o /boot/grub/grub.cfg

# Configuración avanzada del sistema
[ -f /etc/vconsole.conf ] || touch /etc/vconsole.conf
sed -i 's/^HOOKS=.*/HOOKS=(base systemd autodetect keyboard sd-vconsole modconf block sd-encrypt lvm2 filesystems fsck)/' /etc/mkinitcpio.conf
mkinitcpio -P

# Configurar crypttab con UUID persistentes
echo "root_crypt UUID=$(blkid -s UUID -o value /dev/sda4) none luks,discard" > /etc/crypttab
echo "home_crypt UUID=$(blkid -s UUID -o value /dev/sda3) none luks,discard" >> /etc/crypttab

# Instalación de paquetes adicionales
echo -e "\033[32m==== EXTRAS ====\033[0m"
./extras
